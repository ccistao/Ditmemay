local Players, Replicated, TweenService, RunService =
	game:GetService("Players"),
	game:GetService("ReplicatedStorage"),
	game:GetService("TweenService"),
	game:GetService("RunService")

local LocalPlayer, PlayerGui = Players.LocalPlayer, Players.LocalPlayer:WaitForChild("PlayerGui")

-- Xóa banner cũ
for _, name in ipairs({"RunnerUsedBanner", "SkillChosenBanner", "StalkerUsedBanner"}) do
	local old = PlayerGui:FindFirstChild(name)
	if old then old:Destroy() end
end
if _G.RunnerUsedConnection then _G.RunnerUsedConnection:Disconnect() end

-- Viền cầu vồng
local function createRainbowBorder(frame)
	local gradient = Instance.new("UIGradient")
	gradient.Color = ColorSequence.new({
		ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 0)),
		ColorSequenceKeypoint.new(0.17, Color3.fromRGB(255, 127, 0)),
		ColorSequenceKeypoint.new(0.33, Color3.fromRGB(255, 255, 0)),
		ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0, 255, 0)),
		ColorSequenceKeypoint.new(0.67, Color3.fromRGB(0, 0, 255)),
		ColorSequenceKeypoint.new(0.83, Color3.fromRGB(75, 0, 130)),
		ColorSequenceKeypoint.new(1, Color3.fromRGB(148, 0, 211)),
	})
	gradient.Rotation = 0
	gradient.Parent = frame

	if _G.RainbowConnection then _G.RainbowConnection:Disconnect() end
	_G.RainbowConnection = RunService.RenderStepped:Connect(function()
		if gradient then gradient.Rotation = (gradient.Rotation + 1) % 360 end
	end)
end

-- Banner
local function showBanner(text, name)
	if PlayerGui:FindFirstChild(name) then return end
	local gui = Instance.new("ScreenGui", PlayerGui)
	gui.Name = name

	local label = Instance.new("TextLabel", gui)
	label.Size, label.Position = UDim2.new(0, 250, 0, 40), UDim2.new(1, 10, 0, 10)
	label.BackgroundColor3, label.TextColor3 = Color3.fromRGB(30, 30, 30), Color3.new(1, 1, 1)
	label.Font, label.TextScaled, label.Text = Enum.Font.SourceSansBold, true, text

	createRainbowBorder(label)

	local tweenIn = TweenService:Create(label, TweenInfo.new(0.4), {Position = UDim2.new(1, -270, 0, 10)})
	local tweenOut = TweenService:Create(label, TweenInfo.new(0.4), {Position = UDim2.new(1, 10, 0, 10)})

	tweenIn:Play()
	tweenIn.Completed:Wait()
	task.delay(3.4, function()
		tweenOut:Play()
		tweenOut.Completed:Wait()
		gui:Destroy()
	end)
end

-- Lấy Beast
local function getBeast()
	for _, player in ipairs(Players:GetPlayers()) do
		local stats = player:FindFirstChild("TempPlayerStatsModule")
		if stats and stats:FindFirstChild("IsBeast") and stats.IsBeast.Value then
			return player
		end
	end
end

-- Theo dõi Stalker
local function watchLights(beast)
	task.spawn(function()
		local light
		repeat
			if beast and beast.Character then
				light = beast.Character:FindFirstChildWhichIsA("PointLight", true)
			end
			task.wait(0.1)
		until light

		local lightWasOn = light.Enabled and light.Brightness > 0
		while beast and beast.Character and light and light.Parent do
			local isNowOff = not light.Enabled or light.Brightness == 0
			if lightWasOn and isNowOff then
				showBanner("Beast used Q (Stalker) !!!", "StalkerUsedBanner")
				repeat task.wait(0.1) until light.Enabled and light.Brightness > 0
			end
			lightWasOn = light.Enabled and light.Brightness > 0
			task.wait(0.1)
		end
	end)
end

-- Quét skill
local function startSkillScan()
	local foundSkill, skillName = false, "Unknown"

	local function checkSkill(obj)
		if obj:IsA("StringValue") or obj:IsA("BoolValue") then
			local val = tostring(obj.Value):lower()
			if val:find("stalker") then
				skillName, foundSkill = "Stalker", true
			elseif val:find("runner") then
				skillName, foundSkill = "Runner", true
			end
		end
	end

	if _G.SkillScanConnection then _G.SkillScanConnection:Disconnect() end
	_G.SkillScanConnection = Replicated.DescendantAdded:Connect(function(obj)
		if not foundSkill then task.defer(checkSkill, obj) end
	end)

	task.spawn(function()
		local timeout = 10
		while not foundSkill and timeout > 0 do
			for _, obj in ipairs(Replicated:GetDescendants()) do
				if not foundSkill then checkSkill(obj) end
			end
			timeout -= 0.5
			task.wait(0.5)
		end
		if _G.SkillScanConnection then _G.SkillScanConnection:Disconnect() end

		showBanner("Beast chose " .. skillName, "SkillChosenBanner")
		if skillName == "Stalker" then
			local beast = getBeast()
			if beast then watchLights(beast) end
		end
	end)
end

-- Main
local lastBeast, lastQ, lastGameActive = nil, false, false
task.spawn(function()
	while true do
		local gameStatus = Replicated:FindFirstChild("IsGameActive")
		local isGameActive = gameStatus and gameStatus:IsA("BoolValue") and gameStatus.Value

		if isGameActive and not lastGameActive then
			lastBeast, lastQ = nil, false
			startSkillScan()
		end
		lastGameActive = isGameActive

		local currentBeast = getBeast()
		if currentBeast then
			if currentBeast ~= lastBeast then lastBeast, lastQ = currentBeast, false end
			local humanoid = currentBeast.Character and currentBeast.Character:FindFirstChild("Humanoid")
			if humanoid then
				local speed = humanoid.WalkSpeed
				if speed > 19 and not lastQ then
					lastQ = true
					showBanner("Beast used Q (Runner) !!!", "RunnerUsedBanner")
				elseif speed <= 19 then
					lastQ = false
				end
			end
		end
		task.wait(0.05)
	end
end)
