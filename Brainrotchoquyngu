local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

local function clearESP(player)
	if player.Character then
		local h = player.Character:FindFirstChild("ESPHighlight")
		if h then h:Destroy() end
		if player.Character:FindFirstChild("NameBillboard") then
			player.Character.NameBillboard:Destroy()
		end
	end
end

local function createESP(player)
	if player == LocalPlayer then return end
	if not player.Character then return end

	clearESP(player)

	local highlight = Instance.new("Highlight")
	highlight.Name = "ESPHighlight"
	highlight.FillColor = Color3.fromRGB(255, 255, 255)
	highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
	highlight.FillTransparency = 0.8
	highlight.OutlineTransparency = 0
	highlight.Adornee = player.Character
	highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
	highlight.Parent = player.Character

	local head = player.Character:FindFirstChild("Head")
	if head then
		local billboard = Instance.new("BillboardGui")
		billboard.Name = "NameBillboard"
		billboard.Adornee = head
		billboard.Size = UDim2.new(0, 100, 0, 30)
		billboard.StudsOffset = Vector3.new(0, 2.5, 0)
		billboard.AlwaysOnTop = true

		local nameLabel = Instance.new("TextLabel")
		nameLabel.Size = UDim2.new(1, 0, 1, 0)
		nameLabel.BackgroundTransparency = 1
		nameLabel.Text = player.Name
		nameLabel.TextColor3 = Color3.new(1, 1, 1)
		nameLabel.TextStrokeTransparency = 0.7
		nameLabel.TextScaled = true
		nameLabel.Font = Enum.Font.SourceSans
		nameLabel.Parent = billboard

		billboard.Parent = player.Character
	end
end

local function refreshAllESP()
	for _, player in pairs(Players:GetPlayers()) do
		if player.Character then
			createESP(player)
		end
	end
end

Players.PlayerAdded:Connect(function(player)
	player.CharacterAdded:Connect(function()
		wait(1)
		refreshAllESP()
	end)
end)

Players.PlayerRemoving:Connect(function()
	refreshAllESP()
end)

for _, player in pairs(Players:GetPlayers()) do
	player.CharacterAdded:Connect(function()
		wait(1)
		refreshAllESP()
	end)
end

-- GUI chung
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ESP_ShiftLock_GUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- Nút Shift Lock
local shiftButton = Instance.new("TextButton")
shiftButton.Size = UDim2.new(0, 120, 0, 30)
shiftButton.Position = UDim2.new(1, -130, 1, -250)
shiftButton.Text = "Shift Lock: OFF"
shiftButton.BackgroundColor3 = Color3.fromRGB(255, 170, 0)
shiftButton.TextColor3 = Color3.new(1, 1, 1)
shiftButton.TextSize = 14
shiftButton.BorderSizePixel = 0
shiftButton.Parent = screenGui

local shiftLocked = false

shiftButton.MouseButton1Click:Connect(function()
	shiftLocked = not shiftLocked
	shiftButton.Text = "Shift Lock: " .. (shiftLocked and "ON" or "OFF")
end)

RunService.RenderStepped:Connect(function()
	if shiftLocked and LocalPlayer.Character and Camera then
		local hrp = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
		if hrp then
			local lookVec = Camera.CFrame.LookVector
			hrp.CFrame = CFrame.new(hrp.Position, Vector3.new(
				lookVec.X + hrp.Position.X,
				hrp.Position.Y,
				lookVec.Z + hrp.Position.Z
			))
		end
	end
end)

-- Đảm bảo GUI không mất khi respawn
LocalPlayer.CharacterAdded:Connect(function()
	task.wait(1)
	if not screenGui or not screenGui.Parent then
		screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")
	end
	refreshAllESP()
end)

RunService.RenderStepped:Connect(function()
	if not LocalPlayer:FindFirstChild("PlayerGui") then return end
	if not LocalPlayer.PlayerGui:FindFirstChild("ESP_ShiftLock_GUI") then
		screenGui.Parent = LocalPlayer.PlayerGui
	end
end)

refreshAllESP()
