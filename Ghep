--// Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local Replicated = game:GetService("ReplicatedStorage")

--// Local Player
local plr = Players.LocalPlayer
repeat task.wait() until plr and plr:FindFirstChild("PlayerGui")

--// Intro
local guiIntro = Instance.new("ScreenGui")
guiIntro.Parent = plr.PlayerGui
guiIntro.ResetOnSpawn = false
guiIntro.Name = "IntroGui"

local frameIntro = Instance.new("Frame")
frameIntro.Parent = guiIntro
frameIntro.Size = UDim2.new(1,0,1,0)
frameIntro.BackgroundTransparency = 1

local function createText(t,y,s)
    local l = Instance.new("TextLabel")
    l.Parent = frameIntro
    l.Text = t
    l.Size = UDim2.new(0,600,0,60)
    l.Position = UDim2.new(0.5,0,0.5,y)
    l.AnchorPoint = Vector2.new(0.5,0.5)
    l.BackgroundTransparency = 1
    l.TextColor3 = Color3.new(1,1,1)
    l.TextStrokeTransparency = 0.2
    l.TextStrokeColor3 = Color3.fromRGB(0,170,255)
    l.Font = Enum.Font.GothamBold
    l.TextTransparency = 1
    l.TextScaled = false
    l.TextSize = s or 36
    return l
end

local main = createText("script made by trongluong",-35,38)
local sub = createText("ver 1.0.0",10,26)

local function fade(lbl, a)
    if lbl and lbl.Parent then
        TweenService:Create(lbl, TweenInfo.new(1), {TextTransparency = a}):Play()
    end
end

fade(main,0); fade(sub,0)
task.wait(2)
fade(main,1); fade(sub,1)
task.wait(1.5)
pcall(function() guiIntro:Destroy() end)

--// Detect Platform
local function isMobile()
    return UIS.TouchEnabled and not UIS.KeyboardEnabled
end

--// MAIN MENU
local ver = "v0.3.4"
local FTFHAX = Instance.new("ScreenGui", plr.PlayerGui)
FTFHAX.Name = "FTFHAX"

local MenusTabFrame = Instance.new("Frame", FTFHAX)
MenusTabFrame.Name = "MenusTabFrame"
MenusTabFrame.AnchorPoint = Vector2.new(1, 0.5)
MenusTabFrame.BackgroundTransparency = 1
MenusTabFrame.Position = UDim2.new(1, 0, 0.5, 0)
MenusTabFrame.Size = UDim2.new(0.08, 0, 0.16, 0)
MenusTabFrame.SizeConstraint = Enum.SizeConstraint.RelativeYY

local CheatButton = Instance.new("ImageButton", MenusTabFrame)
CheatButton.Name = "CheatButton"
CheatButton.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
CheatButton.BackgroundTransparency = 0.5
CheatButton.BorderSizePixel = 0
CheatButton.Position = UDim2.new(-0.08, 0, 0.79, 0)
CheatButton.Size = UDim2.new(1.12, 0, 1.12, 0)
CheatButton.SizeConstraint = Enum.SizeConstraint.RelativeXX
CheatButton.Image = "rbxassetid://7059346373"

local TextLabel = Instance.new("TextLabel", CheatButton)
TextLabel.AnchorPoint = Vector2.new(0, 1)
TextLabel.BackgroundTransparency = 1
TextLabel.Position = UDim2.new(0, 0, 1, 0)
TextLabel.Size = UDim2.new(1, 0, 0.2, 0)
TextLabel.Font = Enum.Font.GothamBold
TextLabel.Text = "setting"
TextLabel.TextColor3 = Color3.new(1,1,1)
TextLabel.TextScaled = true
TextLabel.TextStrokeTransparency = 0
TextLabel.TextYAlignment = Enum.TextYAlignment.Bottom

local MainMenuWindow = Instance.new("Frame", FTFHAX)
MainMenuWindow.Name = "MainMenuWindow"
MainMenuWindow.AnchorPoint = Vector2.new(0.5, 0.5)
MainMenuWindow.BackgroundColor3 = Color3.fromRGB(47, 47, 47)
MainMenuWindow.BorderSizePixel = 3
MainMenuWindow.BorderColor3 = Color3.fromRGB(1, 1, 1)
MainMenuWindow.Position = UDim2.new(0.5, 0, 0.5, -29)
MainMenuWindow.Size = UDim2.new(0, 672, 0, 510)
MainMenuWindow.Visible = false

local TopBar_2 = Instance.new("Frame", MainMenuWindow)
TopBar_2.Name = "TopBar"
TopBar_2.BackgroundColor3 = Color3.fromRGB(31, 31, 31)
TopBar_2.BorderSizePixel = 0
TopBar_2.Size = UDim2.new(1, 0, 0, 65)

local CloseButton_2 = Instance.new("TextButton", TopBar_2)
CloseButton_2.Name = "CloseButton"
CloseButton_2.AnchorPoint = Vector2.new(1, 0)
CloseButton_2.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
CloseButton_2.Position = UDim2.new(1, -1, 0, 1)
CloseButton_2.Size = UDim2.new(0, 57, 0, 57)
CloseButton_2.Text = "X"
CloseButton_2.Font = Enum.Font.GothamBold
CloseButton_2.TextColor3 = Color3.new(1,1,1)
CloseButton_2.TextScaled = true

local PageTitleText_2 = Instance.new("TextLabel", TopBar_2)
PageTitleText_2.Name = "PageTitleText"
PageTitleText_2.BackgroundTransparency = 1
PageTitleText_2.Position = UDim2.new(0, 10, 0.1, 0)
PageTitleText_2.Size = UDim2.new(0.8, 0, 0, 50)
PageTitleText_2.Text = "Extended Flee The Facility"
PageTitleText_2.Font = Enum.Font.GothamBold
PageTitleText_2.TextColor3 = Color3.new(1,1,1)
PageTitleText_2.TextScaled = true
PageTitleText_2.TextXAlignment = Enum.TextXAlignment.Left

local Body_2 = Instance.new("Frame", MainMenuWindow)
Body_2.Name = "Body"
Body_2.AnchorPoint = Vector2.new(0.5, 0)
Body_2.BackgroundTransparency = 1
Body_2.Position = UDim2.new(0.5, 0, 0, 60)
Body_2.Size = UDim2.new(1, -10, 1, -65)

local UIGridLayout_2 = Instance.new("UIGridLayout", Body_2)
UIGridLayout_2.HorizontalAlignment = Enum.HorizontalAlignment.Center
UIGridLayout_2.SortOrder = Enum.SortOrder.LayoutOrder
UIGridLayout_2.VerticalAlignment = Enum.VerticalAlignment.Center
UIGridLayout_2.CellSize = UDim2.new(0, 210, 0, 210)

if isMobile() then
    PageTitleText_2.Position = UDim2.new(0, 10, 0, 0)
    PageTitleText_2.Size = UDim2.new(0.8, 0, 0, 40)
    CheatButton.Position = UDim2.new(-0.75, 0, 0.68, 0)
    CheatButton.Size = UDim2.new(1.7, 0, 1.7, 0)
    MainMenuWindow.Size = UDim2.new(0, 420, 0, 320)
    TopBar_2.Size = UDim2.new(1, 0, 0, 40)
    CloseButton_2.Size = UDim2.new(0, 36, 0, 36)
    UIGridLayout_2.CellSize = UDim2.new(0, 132, 0, 132)
    Body_2.Position = UDim2.new(0.5, 0, 0, 45)
    Body_2.Size = UDim2.new(1, -10, 1, -50)
end

local Button1 = Instance.new("ImageButton")
local Button2 = Instance.new("ImageButton")
local Button3 = Instance.new("ImageButton")
local Button4 = Instance.new("ImageButton")
local Button5 = Instance.new("ImageButton")
local Button6 = Instance.new("ImageButton")

--// Toggle system
local activeStates = {}
local function makeButton(btn, text, iconId, index, callback)
    btn.BackgroundColor3 = Color3.fromRGB(63, 63, 63)
    btn.Size = UDim2.new(0, 100, 0, 100)
    btn.Parent = Body_2

    local icon = Instance.new("ImageLabel", btn)
    icon.BackgroundTransparency = 1
    icon.AnchorPoint = Vector2.new(0.5,0.5)
    icon.Position = UDim2.new(0.5,0,0.45,0)
    icon.Size = UDim2.new(0.9,0,0.9,0)
    icon.Image = iconId or ""

    local bottom = Instance.new("TextLabel", btn)
    bottom.BackgroundTransparency = 1
    bottom.Position = UDim2.new(0, 0, 0.8, 0)
    bottom.Size = UDim2.new(1, 0, 0.2, 0)
    bottom.Text = text
    bottom.Font = Enum.Font.GothamBold
    bottom.TextColor3 = Color3.new(1,1,1)
    bottom.TextScaled = true

    activeStates[index] = false
    btn.MouseButton1Down:Connect(function()
        activeStates[index] = not activeStates[index]
        if activeStates[index] then
            btn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
        else
            btn.BackgroundColor3 = Color3.fromRGB(63, 63, 63)
        end
        if callback then callback(activeStates[index]) end
    end)
end

-- ===== HÀM HỖ TRỢ BEAST TRACKER =====
local beastTrackerRunning = false
local beastConnections = {}

local function ensureCooldownUI()
    local existing = plr.PlayerGui:FindFirstChild("BeastCooldownUI")
    if existing then
        return existing:FindFirstChild("CooldownLabel")
    end
    
    local gui = Instance.new("ScreenGui")
    gui.Name = "BeastCooldownUI"
    gui.Parent = plr.PlayerGui
    gui.ResetOnSpawn = false
    
    local label = Instance.new("TextLabel")
    label.Name = "CooldownLabel"
    label.Parent = gui
    label.Size = UDim2.new(0, 180, 0, 40)
    label.Position = UDim2.new(0.5, -200, 0, 80)
    label.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    label.BackgroundTransparency = 0.3
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextScaled = true
    label.Font = Enum.Font.GothamBold
    label.Text = "Finding beast..."
    label.TextStrokeTransparency = 0.5
    label.Active = true  -- Cho phép tương tác
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = label
    
    -- ===== DRAG SYSTEM CHO CD UI =====
    local dragging = false
    local dragInput
    local dragStart
    local startPos
    
    local function update(input)
        local delta = input.Position - dragStart
        label.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
    
    label.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = label.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    label.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UIS.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
    -- ===== END DRAG =====
    
    return label
end

-- Hàm tạo viền rainbow
local function createRainbowBorder(frame)
    local gradient = Instance.new("UIGradient")
    gradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 0, 0)),
        ColorSequenceKeypoint.new(0.17, Color3.fromRGB(255, 127, 0)),
        ColorSequenceKeypoint.new(0.33, Color3.fromRGB(255, 255, 0)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(0, 255, 0)),
        ColorSequenceKeypoint.new(0.67, Color3.fromRGB(0, 0, 255)),
        ColorSequenceKeypoint.new(0.83, Color3.fromRGB(75, 0, 130)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(148, 0, 211)),
    })
    gradient.Parent = frame

    local conn
    conn = RunService.RenderStepped:Connect(function()
        if gradient and gradient.Parent then
            gradient.Rotation = (gradient.Rotation + 2) % 360
        else
            conn:Disconnect()
        end
    end)
end

-- Hàm hiển thị banner với rainbow border
local function showBanner(text, name)
    local existing = plr.PlayerGui:FindFirstChild(name)
    if existing then 
        pcall(function() existing:Destroy() end)
    end
    
    local gui = Instance.new("ScreenGui")
    gui.Name = name
    gui.Parent = plr.PlayerGui
    gui.ResetOnSpawn = false

    local label = Instance.new("TextLabel")
    label.Parent = gui
    label.Size = UDim2.new(0, 250, 0, 40)
    label.Position = UDim2.new(1, 10, 0, 10)  -- Bắt đầu ngoài màn hình bên phải
    label.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
    label.TextColor3 = Color3.new(1, 1, 1)
    label.Font = Enum.Font.GothamBold
    label.TextScaled = true
    label.Text = text
    label.BorderSizePixel = 3
    label.BorderColor3 = Color3.new(1, 1, 1)

    -- Thêm padding cho text
    local padding = Instance.new("UIPadding")
    padding.PaddingLeft = UDim.new(0, 10)
    padding.PaddingRight = UDim.new(0, 10)
    padding.PaddingTop = UDim.new(0, 5)
    padding.PaddingBottom = UDim.new(0, 5)
    padding.Parent = label

    -- Tạo rainbow border
    createRainbowBorder(label)

    -- Animation trượt vào
    local tweenIn = TweenService:Create(label, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.Out), 
        {Position = UDim2.new(1, -260, 0, 10)}
    )
    
    -- Animation trượt ra
    local tweenOut = TweenService:Create(label, TweenInfo.new(0.4, Enum.EasingStyle.Back, Enum.EasingDirection.In), 
        {Position = UDim2.new(1, 10, 0, 10)}
    )

    tweenIn:Play()
    tweenIn.Completed:Wait()
    
    task.delay(3.4, function()
        tweenOut:Play()
        tweenOut.Completed:Wait()
        pcall(function() gui:Destroy() end)
    end)
    
    print("[DEBUG] Rainbow banner created:", text)
end

-- Cave check
local caveMin, caveMax = Vector3.new(-275,-10,-275), Vector3.new(-179,45,-179)
local function isOutsideCave(p)
    if not p then return false end
    return p.X < caveMin.X or p.X > caveMax.X or p.Y < caveMin.Y or p.Y > caveMax.Y or p.Z < caveMin.Z or p.Z > caveMax.Z
end

local function disconnectBeastTracker()
    if _G.BeastHeartbeat then
        _G.BeastHeartbeat:Disconnect()
        _G.BeastHeartbeat = nil
    end
    
    for _, conn in ipairs(beastConnections) do
        if typeof(conn) == "RBXScriptConnection" then
            conn:Disconnect()
        end
    end
    beastConnections = {}
end

local function setBeastTrackerVisible(state)
    local g = plr.PlayerGui:FindFirstChild("BeastCooldownUI")
    if g and g:IsA("ScreenGui") then
        g.Enabled = state
    end
end

-- ===== BEAST TRACKER =====
local beast, foundBeast, skill = nil, false, "Unknown"
local cooldownStart, usedRunner, stalkerActive = nil, false, false
local labelCooldown = nil

local function startBeastTracker()
    if beastTrackerRunning then return end
    beastTrackerRunning = true
    
    -- Tìm UI cũ hoặc tạo mới
    labelCooldown = plr.PlayerGui:FindFirstChild("BeastCooldownUI") and 
                    plr.PlayerGui.BeastCooldownUI:FindFirstChild("CooldownLabel") or 
                    ensureCooldownUI()
    
    setBeastTrackerVisible(true)  -- Hiện UI
    
    -- Reset text
    if labelCooldown then
        labelCooldown.Text = "Finding beast..."
    end

    beast, foundBeast, skill = nil, false, "Unknown"
    cooldownStart, usedRunner, stalkerActive = nil, false, false

    local runningDots = false
    task.spawn(function()
        if runningDots then return end
        runningDots = true
        local dots = 0
        while task.wait(0.5) do
            if not foundBeast and labelCooldown and labelCooldown.Parent then
                dots = (dots % 3) + 1
                labelCooldown.Text = "Finding new beast" .. string.rep(".", dots)
            end
        end
    end)

    local function detectSkillWhenGameActive()
        task.spawn(function()
            local gameActive = Replicated:WaitForChild("IsGameActive")
            if gameActive:IsA("BoolValue") then
                repeat task.wait(0.5) until gameActive.Value == true
            end

            if not foundBeast or not beast or not Players:FindFirstChild(beast.Name) then return end

            local power
            repeat
                power = Replicated:FindFirstChild("CurrentPower")
                task.wait(0.5)
            until power and power:IsA("StringValue")

            if not foundBeast or not beast or not Players:FindFirstChild(beast.Name) then return end

            skill = tostring(power.Value):lower()
            showBanner("Beast chose " .. skill, "SkillChosenBanner")

            power:GetPropertyChangedSignal("Value"):Connect(function()
                if foundBeast and beast and Players:FindFirstChild(beast.Name) then
                    skill = tostring(power.Value):lower()
                end
            end)
        end)
    end

    local function isBeast(player)
        if not player then return false end
        local s = player:FindFirstChild("TempPlayerStatsModule")
        return s and s:FindFirstChild("IsBeast") and s.IsBeast.Value
    end

    local runningScan = false
    task.spawn(function()
        if runningScan then return end
        runningScan = true
        while task.wait(0.05) do
            if foundBeast then
                if not beast or not Players:FindFirstChild(beast.Name) or not isBeast(beast) then
                    beast, foundBeast, skill = nil, false, "Unknown"
                    cooldownStart, usedRunner, stalkerActive = nil, false, false
                    if labelCooldown then labelCooldown.Text = "Finding new beast..." end
                end
            end

            if not foundBeast then
                for _, p in ipairs(Players:GetPlayers()) do
                    if isBeast(p) then
                        beast, foundBeast = p, true
                        showBanner(beast.Name .. " is Beast!!!", "BeastBanner")
                        detectSkillWhenGameActive()
                        if labelCooldown then labelCooldown.Text = "Found beast!!!" end
                        task.delay(2.5, function()
                            if foundBeast and labelCooldown then
                                labelCooldown.Text = "Cooldown: Perk Ready!!!"
                            end
                        end)
                        break
                    end
                end
            end
        end
    end)

    -- Monitor skill & cooldown (chỉ tạo 1 connection duy nhất)
if _G.BeastHeartbeat then
    _G.BeastHeartbeat:Disconnect()
end

_G.BeastHeartbeat = RunService.Heartbeat:Connect(function()
    if not foundBeast or not beast or not Players:FindFirstChild(beast.Name) then return end
    if not labelCooldown or not labelCooldown.Parent then return end

    local hum = beast.Character and beast.Character:FindFirstChild("Humanoid")
    local root = beast.Character and beast.Character:FindFirstChild("HumanoidRootPart")
    if not hum then return end

    -- RUNNER
if skill == "runner" then
        if hum.WalkSpeed > 20 and not usedRunner then
            usedRunner = true
            showBanner("Beast used Q (Runner) !!!", "RunnerUsedBanner")

            task.spawn(function()
                local startUse = tick()
                repeat
                    if not foundBeast then return end
                    if labelCooldown and labelCooldown.Parent then
                        labelCooldown.Text = string.format("Using Runner (%.1fs)", math.max(0, 3 - (tick() - startUse)))
                    end
                    RunService.Heartbeat:Wait()
                until tick() - startUse >= 3

                local waitStart = tick()
                repeat
                    RunService.Heartbeat:Wait()
                    if not foundBeast or not beast or not Players:FindFirstChild(beast.Name) then return end
                    local currentHum = beast.Character and beast.Character:FindFirstChild("Humanoid")
                    if not currentHum then return end
                    if tick() - waitStart > 1.5 then break end
                until currentHum.WalkSpeed <= 19

                local startCD = tick()
                repeat
                    if not foundBeast then return end
                    if labelCooldown and labelCooldown.Parent then
                        labelCooldown.Text = string.format("Cooldown: %.1fs", math.max(0, 22 - (tick() - startCD)))
                    end
                    RunService.Heartbeat:Wait()
                until tick() - startCD >= 22

                if foundBeast and labelCooldown and labelCooldown.Parent then
                    labelCooldown.Text = "Cooldown: Runner Ready!!!"
                end
                usedRunner = false
            end)
        end

    -- STALKER
    elseif skill == "stalker" then
        local anyOff = false
        for _, o in ipairs(beast.Character:GetDescendants()) do
            if o:IsA("PointLight") or o:IsA("SurfaceLight") or o:IsA("SpotLight") then
                if not o.Enabled or (o.Brightness and o.Brightness == 0) then
                    anyOff = true
                    break
                end
            end
        end

        if root and anyOff and not stalkerActive and isOutsideCave(root.Position) then
            stalkerActive = true
            showBanner("Beast used Q (Stalker) !!!", "StalkerUsedBanner")

            task.spawn(function()
                local startUse = tick()
                repeat
                    if not foundBeast then return end
                    if labelCooldown and labelCooldown.Parent then
                        labelCooldown.Text = string.format("Using Stalker (%.1fs)", math.max(0, 7 - (tick() - startUse)))
                    end
                    RunService.Heartbeat:Wait()
                until tick() - startUse >= 7

                local waitStart = tick()
                repeat
                    RunService.Heartbeat:Wait()
                    if not foundBeast or not beast or not Players:FindFirstChild(beast.Name) then 
                        stalkerActive = false
                        return 
                    end
                    if not beast.Character then 
                        stalkerActive = false
                        return 
                    end
                    
                    if tick() - waitStart > 2 then break end
                    
                    local allOn = true
                    for _, o in ipairs(beast.Character:GetDescendants()) do
                        if o:IsA("PointLight") or o:IsA("SurfaceLight") or o:IsA("SpotLight") then
                            if not o.Enabled or (o.Brightness and o.Brightness == 0) then
                                allOn = false
                                break
                            end
                        end
                    end
                until allOn

                local startCD = tick()
                repeat
                    if not foundBeast then return end
                    if labelCooldown and labelCooldown.Parent then
                        labelCooldown.Text = string.format("Cooldown: %.1fs", math.max(0, 20 - (tick() - startCD)))
                    end
                    RunService.Heartbeat:Wait()
                until tick() - startCD >= 20

                if foundBeast and labelCooldown and labelCooldown.Parent then
                    labelCooldown.Text = "Cooldown: Stalker Ready!!!"
                end
                stalkerActive = false
            end)
        end
    end
end)
end

local function stopBeastTracker()
    beastTrackerRunning = false
    setBeastTrackerVisible(false)
    disconnectBeastTracker()
end

-- ===== PC PROGRESS =====
local pcProgressRunning = false
local pcConnections = {}

local function disconnectPCProgress()
    for _,c in ipairs(pcConnections) do
        if typeof(c) == "RBXScriptConnection" then
            c:Disconnect()
        end
    end
    pcConnections = {}
end

local function stopPCProgress()
    pcProgressRunning = false
    disconnectPCProgress()
    
    -- Chỉ ẩn, không xóa
    for _,v in pairs(workspace:GetDescendants()) do
        if v:IsA("BillboardGui") and v.Name == "PCProgressBB" then
            v.Enabled = false
        end
    end
end

local function startPCProgress()
    if pcProgressRunning then return end
    pcProgressRunning = true

    -- Hiện lại các billboard cũ nếu có
    for _,v in pairs(workspace:GetDescendants()) do
        if v:IsA("BillboardGui") and v.Name == "PCProgressBB" then
            v.Enabled = true
        end
    end

    local RS = Replicated
    local Camera = workspace.CurrentCamera
    local LocalPlayer = plr

    local pcLabels, finished, pcState, hookedPCs, lastPercent = {}, {}, {}, {}, {}
    local pendingUpdate = {}
    local UPDATE_INTERVAL = 0.1
    local SHOW_DISTANCE_SURV = 40
    local SHOW_DISTANCE_BEAST = 20
    local currentShowDist = SHOW_DISTANCE_SURV
    local CHECK_OFFSET = Vector3.new(0, 1, 0)
    local CHECK_RADIUS = 2

    local function findAttachPart(pc)
        if pc:IsA("Model") then
            local scr = pc:FindFirstChild("Screen")
            if scr and scr:IsA("BasePart") then return scr end
            if pc.PrimaryPart then return pc.PrimaryPart end
            for _,d in ipairs(pc:GetDescendants()) do
                if d:IsA("BasePart") then return d end
            end
        elseif pc:IsA("BasePart") then
            return pc
        end
        return nil
    end

    local function createBillboard(pc)
        if pcLabels[pc] then return pcLabels[pc] end
        local part = findAttachPart(pc)
        if not part then return end
        
        -- Kiểm tra xem đã có billboard cũ chưa
        local existingBB = part:FindFirstChild("PCProgressBB")
        if existingBB then
            existingBB.Enabled = true
            local tl = existingBB:FindFirstChildOfClass("TextLabel")
            if tl then
                pcLabels[pc] = {label = tl, bb = existingBB, part = part}
                lastPercent[pc] = 0
                return pcLabels[pc]
            end
        end
        
        local bb = Instance.new("BillboardGui")
        bb.Name = "PCProgressBB"
        bb.Size = UDim2.new(0, 100, 0, 40)
        bb.StudsOffset = Vector3.new(0, 2, 0)
        bb.AlwaysOnTop = true
        bb.Adornee = part
        bb.Parent = part
        
        local tl = Instance.new("TextLabel")
        tl.Size = UDim2.new(1,0,1,0)
        tl.BackgroundTransparency = 1
        tl.TextColor3 = Color3.new(1,1,1)
        tl.Font = Enum.Font.GothamBold
        tl.TextScaled = true
        tl.Text = "0%"
        tl.Visible = true
        tl.Parent = bb
        
        pcLabels[pc] = {label = tl, bb = bb, part = part}
        lastPercent[pc] = 0
        return pcLabels[pc]
    end

    local function clearAll()
        for _,v in pairs(pcLabels) do
            if v.bb then v.bb.Enabled = false end
        end
        pcLabels, finished, pcState, hookedPCs, lastPercent, pendingUpdate = {}, {}, {}, {}, {}, {}
    end

    local function isVisible(part)
        if not part then return false end
        local camPos = Camera.CFrame.Position
        local partPos = part.Position + CHECK_OFFSET
        local distance = (partPos - camPos).Magnitude
        local dir = (partPos - camPos).Unit * distance
        
        local params = RaycastParams.new()
        params.FilterDescendantsInstances = {LocalPlayer.Character}
        params.FilterType = Enum.RaycastFilterType.Blacklist
        
        local result = workspace:Raycast(camPos, dir, params)
        
        if not result then 
            return true
        end
        
        if result.Instance:IsDescendantOf(part.Parent) then
            return true
        end
        
        return false
    end

    local function queueProgress(pc, value)
        if finished[pc] then return end
        if pcState[pc] == "ERROR" or pcState[pc] == "DONE" then return end
        local percent = math.floor(value * 100 + 0.5)
        if percent >= 100 then
            percent = 100
            finished[pc] = true
        end
        if percent ~= (lastPercent[pc] or -1) then
            if percent == 0 and (lastPercent[pc] or 0) > 0 then
                return
            end
            lastPercent[pc] = percent
            pendingUpdate[pc] = tostring(percent).."%"
        end
    end

    table.insert(pcConnections, task.spawn(function()
        while pcProgressRunning do
            for pc,text in pairs(pendingUpdate) do
                local pack = createBillboard(pc)
                if pack then
                    if pack.label.Text ~= text then
                        pack.label.Text = text
                        pack.label.TextColor3 = Color3.new(1,1,1)
                    end
                end
                pendingUpdate[pc] = nil
            end
            task.wait(UPDATE_INTERVAL)
        end
    end))

    local function nearestPC(pos, maxDist)
        local best,bd = nil, maxDist or 30
        for pc,_ in pairs(pcLabels) do
            local part = pcLabels[pc].part
            if part then
                local dist = (part.Position - pos).Magnitude
                if dist < bd then
                    best, bd = pc, dist
                end
            end
        end
        return best
    end

    local function onActionProgress(plr, value)
        local tps = plr:FindFirstChild("TempPlayerStatsModule")
        if not tps then return end
        local currentAnim = tps:FindFirstChild("CurrentAnimation")
        if not currentAnim or currentAnim.Value ~= "Typing" then return end
        if not plr.Character then return end
        local hrp = plr.Character:FindFirstChild("HumanoidRootPart")
        if not hrp then return end
        local pc = nearestPC(hrp.Position, 35)
        if pc then
            queueProgress(pc, value)
        end
    end

    local function hookPlayer(plr)
        local function attach(c)
            if c.Name == "TempPlayerStatsModule" then
                local ap = c:WaitForChild("ActionProgress", 10)
                if ap and ap:IsA("NumberValue") then
                    table.insert(pcConnections, ap:GetPropertyChangedSignal("Value"):Connect(function()
                        onActionProgress(plr, ap.Value)
                    end))
                end
            end
        end
        plr.ChildAdded:Connect(attach)
        local tps = plr:FindFirstChild("TempPlayerStatsModule")
        if tps then attach(tps) end
    end
    for _,p in ipairs(Players:GetPlayers()) do hookPlayer(p) end
    table.insert(pcConnections, Players.PlayerAdded:Connect(hookPlayer))

    local function updateRole()
        local stats = LocalPlayer:FindFirstChild("TempPlayerStatsModule") or LocalPlayer:FindFirstChild("PlayerStats")
        if stats then
            local isBeast = stats:FindFirstChild("IsBeast")
            if isBeast then
                if isBeast.Value == true then
                    currentShowDist = SHOW_DISTANCE_BEAST
                else
                    currentShowDist = SHOW_DISTANCE_SURV
                end
            end
        end
    end
    
    local function watchStats()
        local stats = LocalPlayer:FindFirstChild("TempPlayerStatsModule") or LocalPlayer:FindFirstChild("PlayerStats")
        if stats then
            local isBeast = stats:FindFirstChild("IsBeast")
            if isBeast then
                table.insert(pcConnections, isBeast.Changed:Connect(updateRole))
                updateRole()
            end
        end
    end
    LocalPlayer.CharacterAdded:Connect(function()
        task.wait(0.5)
        watchStats()
    end)
    watchStats()

    local function applyScreenState(pc, c)
        local pack = createBillboard(pc)
        if not pack then return end
        if c.G > c.R + 0.2 and c.G > c.B + 0.2 then
            pcState[pc] = "DONE"
            pack.label.Text = "DONE"
            pack.label.TextColor3 = Color3.new(0,1,0)
        elseif c.R > c.G + 0.2 and c.R > c.B + 0.2 then
            pcState[pc] = "ERROR"
            pack.label.Text = "ERROR"
            pack.label.TextColor3 = Color3.new(1,0,0)
        else
            if not finished[pc] then
                pcState[pc] = nil
            end
        end
    end
    
    local function watchPC(pc)
        if hookedPCs[pc] then return end
        hookedPCs[pc] = true
        local scr = pc:FindFirstChild("Screen")
        if scr and scr:IsA("BasePart") then
            applyScreenState(pc, scr.Color)
            table.insert(pcConnections, scr:GetPropertyChangedSignal("Color"):Connect(function()
                applyScreenState(pc, scr.Color)
            end))
        end
    end

    table.insert(pcConnections, task.spawn(function()
        while pcProgressRunning do
            local map = RS:FindFirstChild("CurrentMap") and RS.CurrentMap.Value
            if map then
                for _,d in ipairs(map:GetDescendants()) do
                    if d.Name == "ComputerTable" then
                        createBillboard(d)
                        watchPC(d)
                    end
                end
            end
            task.wait(1)
        end
    end))

    table.insert(pcConnections, RunService.RenderStepped:Connect(function()
        local char = LocalPlayer.Character
        local hrp = char and char:FindFirstChild("HumanoidRootPart")
        local camPos = Camera.CFrame.Position
        for pc,pack in pairs(pcLabels) do
            local part,label = pack.part, pack.label
            if part and label then
                local origin = hrp and hrp.Position or camPos
                local dist = (part.Position - origin).Magnitude
                if dist <= currentShowDist and isVisible(part) then
                    label.Visible = true
                else
                    label.Visible = false
                end
            end
        end
    end))

    if RS:FindFirstChild("CurrentMap") then
        table.insert(pcConnections, RS.CurrentMap.Changed:Connect(function()
            clearAll()
        end))
    end
end

-- ===== SỰ KIỆN MỞ/ĐÓNG MENU =====
CheatButton.MouseButton1Down:Connect(function()
    MainMenuWindow.Visible = not MainMenuWindow.Visible
end)

CloseButton_2.MouseButton1Down:Connect(function()
    MainMenuWindow.Visible = false
end)

-- ===== 6 NÚT MENU =====
makeButton(Button1,"Wallhop view","rbxassetid://16994563429",1,function(state)
    if state then
        print("Wallhop view bật")
    else
        print("Wallhop view tắt")
    end
end)

makeButton(Button2,"Flashlight","rbxassetid://106585954087372",2,function(state)
    if state then
        print("Flashlight bật")
    else
        print("Flashlight tắt")
    end
end)

makeButton(Button3,"Self muting","rbxassetid://90332761263250",3,function(state)
    if state then
        print("Self muting bật")
    else
        print("Self muting tắt")
    end
end)

makeButton(Button4,"Beast tracker","rbxassetid://9125495609",4,function(state)
    if state then
        startBeastTracker()
    else
        stopBeastTracker()
    end
end)

makeButton(Button5,"Survivor tracker","rbxassetid://90682070728446",5,function(state)
    if state then
        print("Survivor tracker bật")
    else
        print("Survivor tracker tắt")
    end
end)

makeButton(Button6,"PC progress","rbxassetid://12684119225",6,function(state)
    if state then
        startPCProgress()
    else
        stopPCProgress()
    end
end)
